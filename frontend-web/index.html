<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Signal Messenger v7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 280px;
      background: #161b22;
      padding: 20px;
      box-sizing: border-box;
      border-right: 1px solid #30363d;
    }

    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0d1117;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
    }

    button {
      background: #238636;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    button:disabled {
      background: #30363d;
      cursor: not-allowed;
    }

    #chat-log {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    .msg {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      max-width: 70%;
      line-height: 1.4;
    }

    .me {
      background: #238636;
      margin-left: auto;
      color: white;
    }

    .them {
      background: #30363d;
      color: #e6edf3;
    }

    #msg-input {
      padding: 12px;
      border-radius: 0;
      border-top: 1px solid #30363d;
      background: #161b22;
      color: white;
      font-size: 16px;
    }

  </style>
</head>

<body>
  <div class="sidebar">
    <h2>Signal v7</h2>

    <label>Ваш username</label>
    <input id="username" placeholder="example" />

    <button id="btn-register">Реєстрація</button>

    <hr style="border:1px solid #30363d; margin:15px 0;" />

    <label>Ваш user_id</label>
    <input id="my-id" disabled />

    <label>ID співрозмовника</label>
    <input id="peer-id" placeholder="1234-5678..." />

    <button id="btn-init-session" disabled>Створити сесію</button>
  </div>

  <div class="chat">
    <div id="chat-log"></div>

    <input 
      id="msg-input" 
      placeholder="Напишіть повідомлення..." 
      disabled
    />
    <button id="btn-send" disabled>Надіслати</button>
  </div>

<script>
// ==============================
//   CONFIG
// ==============================

// ⚠️ CHANGE_BACKEND_URL — вставляєш свій бекенд HTTPS URL Railway
const API_BASE = "https://corp-production-0ac7.up.railway.app";

function api(path) {
  return API_BASE + path;
}

let myId = null;
let pollTimer = null;

// ==============================
//   DOM
// ==============================
const usernameInput = document.getElementById("username");
const btnRegister = document.getElementById("btn-register");
const myIdInput = document.getElementById("my-id");
const peerIdInput = document.getElementById("peer-id");
const btnInit = document.getElementById("btn-init-session");
const chatLog = document.getElementById("chat-log");
const msgInput = document.getElementById("msg-input");
const btnSend = document.getElementById("btn-send");

// ==============================
//   HELPERS
// ==============================
function appendMsg(text, me=false) {
  const div = document.createElement("div");
  div.className = "msg " + (me ? "me" : "them");
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

// ==============================
//   REGISTER
// ==============================
btnRegister.onclick = async () => {
  const username = usernameInput.value.trim();
  if (!username) return alert("Введи username");

  const res = await fetch(api("/register"), {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ username })
  });

  const data = await res.json();

  if (data.user_id) {
    myId = data.user_id;
    myIdInput.value = myId;

    btnInit.disabled = false;
    msgInput.disabled = false;
    btnSend.disabled = false;

    startPolling();
  } else {
    alert("Помилка реєстрації");
  }
};

// ==============================
//   INIT SESSION
// ==============================
btnInit.onclick = async () => {
  if (!myId) return alert("Спочатку реєстрація");

  const peer = peerIdInput.value.trim();
  if (!peer) return alert("Введи peer_id");

  const res = await fetch(api("/session/init"), {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ sender_id: myId, receiver_id: peer })
  });

  const data = await res.json();
  if (data.status === "session_established") {
    alert("Сесія створена");
  } else {
    alert("Не вдалося створити сесію");
  }
};

// ==============================
//   SEND MESSAGE
// ==============================
btnSend.onclick = async () => {
  const text = msgInput.value.trim();
  const peer = peerIdInput.value.trim();
  if (!text || !peer) return;

  const res = await fetch(api("/message/send"), {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      sender_id: myId,
      receiver_id: peer,
      text
    })
  });

  const data = await res.json();
  if (data.status === "sent") {
    appendMsg(text, true);
    msgInput.value = "";
  }
};

msgInput.onkeydown = (e) => {
  if (e.key === "Enter") btnSend.click();
};

// ==============================
//   POLL INCOMING MSG
// ==============================
async function pollOnce() {
  if (!myId) return;

  const res = await fetch(api("/message/poll/" + myId));
  const data = await res.json();

  (data.messages || []).forEach(msg => {
    appendMsg(msg.text, false);
  });
}

function startPolling() {
  pollTimer = setInterval(pollOnce, 1500);
}

</script>

</body>
</html>